#!/bin/bash
. $(which lib.alu-detect.sh)
set -e
#set -x

calls_truth_pairs=($(echo "$CALLS_TRUTH_PAIRS" | tr ';' ' '))
calls=()
truth=()
truth_len=()
for pair in ${calls_truth_pairs[@]}; do
    tmp=($(echo "$pair" | tr ':' ' '))
    [ ${#tmp[@]} -ne 2 ] && crash "invalid <calls_bed>:<truth_bed> pair: $pair"
    calls+=(${tmp[0]})
    truth+=(${tmp[1]})
    truth_len+=($(wc -l <${tmp[1]}))
done

#echo "calls: ${calls[@]}" >&2
#echo "truth: ${truth[@]}" >&2
#echo "truth_len: ${truth_len[@]}" >&2

for len in $LEN_VALS ; do
for supp in $SUPP_VALS ; do
for null in $NULL_VALS ; do
for ci_len in $CI_LEN_VALS ; do
    print_tab -n -- $len $supp $null $ci_len ref-alus

    i=0
    while [ $i -lt ${#calls[@]} ]; do
	exec 3< <(<${calls[$i]} exec apply-filter $len $supp $null $ci_len)
	<&3 run_cmds "TRUTH=${truth[$i]} TRUTH_LEN=${truth_len[$i]} get-prec-recall" \
	    "filter-ci-length 100 | TRUTH=${truth[$i]} TRUTH_LEN=${truth_len[$i]} get-prec-recall" \
	    "filter-bp 2 | TRUTH=${truth[$i]} TRUTH_LEN=${truth_len[$i]} get-prec-recall" 2>/dev/null
	exec 3<&-
	print_tab -n -- '' "${CMD_OUTPUT[@]}"
	i=$(($i + 1))
    done

    echo
done
done
done
done
