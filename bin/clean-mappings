#!/bin/bash
. $(which lib.alu-detect.sh)

[ -L /proc/$$/fd/3 ] || crash "fd 3 must be open"

zc "$@" \
    | add-extra-sam-flags -N 4 -l $PAIRING_FILE -P 2>/dev/null \
    | filter-mappings -N 4 -l $PAIRING_FILE -P 2>/dev/null \
	-f 0x10000,0x10000:\&3 \
	-f 0x10000,0x3000/0x4:\&1 \
	-f 0x10000,0x5000/0x4:\&1 \
	-f 0x10000,0:\&3 \
	-f 0x3000/0x4,0x10000:\&1 \
	-f 0x5000/0x4,0x10000:\&1 \
	-f 0,0x10000:\&3 \
	\
	-f 0x4,0x4:\&3 \
	-f 0x4,0/0x1000:\&3 \
	-f 0x4,0:\&1 \
	-f 0/0x1000,0x4:\&3 \
	-f 0,0x4:\&1 \
	\
	-f 0/0x1000,0/0x1000:\&3 \
	-f 0x8000/0x6000,0x8000/0x6000:\&3 \
	-f 0,0:\&1
