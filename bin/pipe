#!/bin/bash
cmds=()
last_cmd_idx=0
for token in $*; do
    if [ $token = "=" ]; then
	let last_cmd_idx+=1
    else
	cmds[$last_cmd_idx]="${cmds[$last_cmd_idx]:-} $token"
    fi
done

command=
i=0
while [ $i -le $last_cmd_idx ]; do
    [ "${cmds[$i]}" ] || { echo "empty command: $i" >&2; exit 1; }
    echo "$i: ${cmds[$i]}" >&2
    [ $i -eq 0 ] || command="$command |"
    command="$command ${cmds[$i]}"
    let i+=1
done
echo "command: $command" >&2

# clone stdout
for fd in $(seq 3 256); do
    [ -L /proc/$$/fd/$fd ] || break
done
[ $fd -le 255 ] || { echo "no available fds?!" >&2; exit 1; }
echo "fd: $fd" >&2

exec ${fd}>&1
ls -l /proc/$$/fd >&2

pipe_status=$(eval "{ $command; } >&${fd} ; echo \${PIPESTATUS[@]}")
echo "got pipe_status: ${pipe_status}" >&2
